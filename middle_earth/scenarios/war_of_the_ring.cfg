[multiplayer]
description=""
id="war_of_the_ring"
map_file="middle_earth.map"
name="8p. War of the Ring"
victory_when_enemies_defeated=yes
[music]
	name=lotr_soundtrack.ogg
    immediate=yes
[/music]
{DEFAULT_SCHEDULE}

[time_area]
	current_time=0
	id="Mordor"
	x="103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121"
	y="61-72,60-75,61-76,61-86,61-86,61-86,61-86,61-86,62-86,62-86,62-86,61-86,62-86,62-86,63-86,62-86,63-86,62-86,63-86"
    {PERMANENT_SHADOW}
[/time_area]

[time_area]
	current_time=0
    id="Fangorn"
	x="55,56,57,58,59,60,61,62,63,64,65,66,67,68"
	y="46-49,45-49,44-51,43-51,43-52,43-52,44-52,44-52,44-52,44-51,45-51,45-50,46-50,47"
    {DEFAULT_SCHEDULE}
[/time_area]

[time_area]
	current_time=0
	id="Ithilien"
	x="89,90,91,92,93,94,95,96,96,97,97,97,98,98,99,100,101,102,103,104,105"
	y="85,84-85,84-86,83-86,83-86,82-86,82-86,62-65,80-85,62-66,74,79-86,62-66,73-86,63-86,60-86,61-86,60-86,73-86,76-86,77-86"
    {DEFAULT_SCHEDULE}
[/time_area]

[time_area]
	current_time=0
	id="Mirkwood"
	x="77,78,79,79,80,80,81,81,82,82,83,83,84,84,85,85,86,86,87,87,88,88,89,90,91,92,93,94,95,96,97,98,99,100,100,101,101,102,102,103,103,104,104,104,105,106"
	y="10-12,9-13,8-14,38-40,7-14,37-40,7-22,37-41,6-23,36-41,6-25,36-42,6-26,36-42,6-28,36-43,6-29,35-42,6-31,35-43,6-31,34-43,7-43,12-43,14-43,15-42,15-43,16-42,16-42,15-41,15-41,15-41,16-41,16-29,31-40,17-30,33-40,17-30,32-38,25-30,33-38,25,29-30,33-37,34-36,34-35"
    {PERMANENT_SHADOW}
[/time_area]

[time_area]
	current_time=0
	id="Woodelf Realm"
	x="90,91,92,93,94,95,96,97,98,102,103,104,105,106"
	y="6-11,7-13,6-14,7-14,6-15,7-15,8-14,9-15,13-14,19,19-24,18-24,20-24,20-23"
    {DEFAULT_SCHEDULE}
[/time_area]

[time_area]
	current_time=0
	id="Dunland"
	x="10,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55"
	y="53,56-61,53-62,49-61,47-61,46-60,47-60,46-59,47-59,46-58,47-58,46-58,47-58,46-58,47-59,46-59,47-59,46-59,47-60,46-59,47-60,46-59,47-59,46-58,47-59,46-58,47-59,46-58,47-59,46-58,47-59,46-58,47-59,46-59,46-60,45-60,46-61,46-61,47-62,47-61,48-55,48-53,49-53,49-52,50-52,49-51,50-51"
    {DEFAULT_SCHEDULE}
[/time_area]

[time_area]
	current_time=0
	id="Lorien"
	x="60,61,61,61,62,63,64,65,65,66,66,67,68,69,70,71,72,73,74,75,76,77,78,79,79,80,80,81,82,83,84,85,86,87,88"
	y="41-42,34-35,38-39,41-43,33-43,33-43,33-43,30,34-44,29-31,33-44,29-45,28-45,29-45,28-44,28-44,28-44,29-45,29-45,29-46,28-45,29-46,28-46,28-37,41-46,28-36,41-45,28-36,28-35,28-35,28-35,29-35,30-34,32-34,32-33"
    {DEFAULT_SCHEDULE}
[/time_area]

[time_area]
	current_time=0
	id="Moria"
	x="39,40,41,42,43,44,45,46,47,48,49,50,50,51,52,53,54,55,56,57,58,59,60,61,61,61,62,63,64,65,65,66,66,67"
	y="32-41,31-42,31-43,30-43,30-44,30-44,30-45,29-45,29-46,28-46,28-47,28-43,45-47,29-48,28-48,28-49,27-48,28-45,29-44,29-43,29-42,28-42,27-40,28-33,36-37,40,27-32,27-32,27-32,27-29,31-33,27-28,32,28"
    {DEFAULT_SCHEDULE}
[/time_area]

[time_area]
	current_time=0
	id="Rivendell"
	x="45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,77,78,78,79,80,81,82,83"
	y="23-28,18-28,17-28,16-27,16-28,14-28,14-28,13-27,13-27,12-26,12-28,11-28,12-28,12-28,12-28,11-26,12-27,11-26,11-26,11-26,11-26,10-26,10-27,9-27,9-28,9-27,10-27,9-27,7-28,6-28,6-28,6-27,7-9,13-27,7-8,14-27,15-27,15-27,22-27,24-27,26-27"
    {DEFAULT_SCHEDULE}
[/time_area]

{LOCAL_TIME_EVENT Mirkwood_local_time 83 38 {OWNED_BY "1,4,7" 83 38} Mirkwood}
{LOCAL_TIME_EVENT Ithilien_local_time 97 72 {OCCUPIED_BY "1,4,7" 97 72} Ithilien}

[side]
    side=1
    faction=Custom
    faction_lock=true
    recruit=
    gold=200
    income=0
    team_name="Shadow"
    side_name="Mordor"
    current_player="Witch King"
    color=black
    no_leader=yes
    [leader]
        type=Ringwraith King
        id=WitchKing
        name=Witch King
        unrenamable=yes
        extra_recruit=Goblin Spearman,Orcish Archer,Orcish Assassin,Orcish Grunt,Orcish Leader,WoR Troll Whelp,Wolf Rider,Ringwraith Shadow
        x=118
        y=65
        [variables]
            std_recruits=Goblin Spearman,Orcish Archer,Orcish Assassin,Orcish Grunt,Orcish Leader,WoR Troll Whelp,Wolf Rider,Ringwraith Shadow
        [/variables]
    [/leader]
    [village] # Barad-dur
        x=118
        y=65
    [/village]
    [village] # Dol Guldur
        x=83
        y=38
    [/village]
    [ai]
        aggression=0.1
        caution=0.75
        support_villages=yes
        scout_village_targeting=3
        village_value=3
        villages_per_scout=2
    [/ai]
[/side]
[side]
    side=2
    faction=Custom
    faction_lock=true
    recruit=
    gold=200
    income=0
    team_name="Free Peoples"
    side_name="Gondor"
    current_player=Imrahil
    color=purple
    no_leader=yes
    [leader]
        type=General
        id=Imrahil
        name=Prince Imrahil
        unrenamable=yes
        extra_recruit=Gondor Bowman,Gondor Cavalryman,Gondor Soldier,Gondor Spearman,Gondor Trooper
        x=92
        y=71
        [variables]
            std_recruits=Gondor Bowman,Gondor Cavalryman,Gondor Soldier,Gondor Spearman,Gondor Trooper
        [/variables]
    [/leader]
    [leader]
        type=Gondor Longbowman
        id=Faramir
 
        first_time_only=no
name=Faramir
        unrenamable=yes
        extra_recruit=Gondor Bowman,Gondor Cavalryman,Gondor Soldier,Gondor Spearman,Gondor Trooper
        x=97  # Osgiliath
        y=72
        [variables]
            std_recruits=Gondor Bowman,Gondor Cavalryman,Gondor Soldier,Gondor Spearman,Gondor Trooper
        [/variables]
    [/leader]
    [leader]
        type=Gondor Fighter
        id=Boromir
        name=Boromir
        unrenamable=yes
        extra_recruit=Gondor Bowman,Gondor Cavalryman,Gondor Soldier,Gondor Spearman,Gondor Trooper
        x=93
        y=71
        [variables]
            std_recruits=Gondor Bowman,Gondor Cavalryman,Gondor Soldier,Gondor Spearman,Gondor Trooper
        [/variables]
    [/leader]
    [village] # Minas Tirith
        x=92
        y=71
    [/village]
    [ai]
        aggression=0.1
        caution=0.75
        support_villages=yes
        scout_village_targeting=3
        village_value=3
        villages_per_scout=2
    [/ai]
    [variables]
        patrol_enemies=Wolf Rider,Vampire Bat
        patrol_waypoints_x=72,62,61,51,49,37,24,13,15,6,23,35,43,49,60,56,69
        patrol_waypoints_y=70,72,68,68,73,68,69,67,76,81,79,76,77,73,76,80,83
    [/variables]
[/side]
[side]
    side=3
    faction=Custom
    faction_lock=true
    recruit=
    gold=200
    income=0
    team_name="Free Peoples"
    side_name="Rohan"
    current_player="Theoden"
    color=blue
    no_leader=yes
    [leader]
        type=Lancer
        id=Theoden
        name=Theoden
        unrenamable=yes
        extra_recruit=Peasant,Bowman,Spearman,Horseman,Cavalryman,Fencer,Woodsman
        x=65
        y=65
        max_moves=7
        [variables]
            std_recruits=Peasant,Bowman,Spearman,Horseman,Cavalryman,Fencer,Woodsman
        [/variables]
    [/leader]
    [village] # Edoras
        x=65
        y=65
    [/village]
    [ai]
        aggression=0.1
        caution=0.75
        support_villages=yes
        scout_village_targeting=3
        village_value=3
        villages_per_scout=2
        [leader_goal]
            id="theoden-to-helms-deep"
            x=58
            y=61
            auto_remove=yes
        [/leader_goal]
    [/ai]
    [variables]
        patrol_enemies=Wolf Rider,Vampire Bat
        patrol_waypoints_x=67,73,77,82,73
        patrol_waypoints_y=60,61,56,53,49
    [/variables]
[/side]
[side]
    side=4
    faction=Custom
    faction_lock=true
    recruit=
    gold=200
    income=0
    team_name="Shadow"
    side_name="Isengard"
    current_player="Saruman"
    color=white
    no_leader=yes
    [leader]
        type=Evil Wizard
        id=Saruman
        name=Saruman the White
        unrenamable=yes
        extra_recruit=Goblin Spearman,Orcish Archer,Orcish Assassin,Orcish Grunt,Orcish Leader,WoR Troll Whelp,Wolf Rider,RfC Orcish Woodcutter,Vampire Bat
        x=49
        y=53
        [variables]
            std_recruits=Goblin Spearman,Orcish Archer,Orcish Assassin,Orcish Grunt,Orcish Leader,WoR Troll Whelp,Wolf Rider,RfC Orcish Woodcutter,Vampire Bat
        [/variables]
    [/leader]
    [leader]
        type=AE_ext_monsters_Overgrown_Spider
        id=Spider Queen
        name=Mirkwood Spider Queen
        extra_recruit=WoR Little Spider,AE_efm_pygmies_Spider_Rider
        x=94
        y=21
        [variables]
            std_recruits=WoR Little Spider,AE_efm_pygmies_Spider_Rider
        [/variables]
    [/leader]
    [village] # Isengard
        x=49
        y=53
    [/village]
    [ai]
        aggression=0.1
        caution=0.75
        support_villages=yes
        scout_village_targeting=3
        village_value=3
        villages_per_scout=4
    [/ai]
    [variables]
        patrol_enemies=Cavalryman,Gondor Cavalryman,Elvish Scout,Dwarvish Scout
        patrol_waypoints_x=44,44,46,35,36,31,32,21,13,7,4,7,13,14,13,33,47,
        patrol_waypoints_y=55,50,47,52,51,50,42,47,51,53,43,39,51,57,67,62,61
    [/variables]
[/side]
[side]
    side=5
    faction=Custom
    faction_lock=true
    recruit=
    gold=200
    income=0
    team_name="Free Peoples"
    side_name="Elves"
    current_player="Elrond"
    color=green
    no_leader=yes
    [leader]
        type=Elvish High Lord
        id=Elrond
        name=Elrond
        unrenamable=yes
        extra_recruit=Elvish Archer,Elvish Fighter,Elvish Scout,Elvish Shaman,Mage
        x=59
        y=21
        [abilities]
            {ABILITY_CURES}
        [/abilities]
        [variables]
            std_recruits=Elvish Archer,Elvish Fighter,Elvish Scout,Elvish Shaman,Mage
        [/variables]
    [/leader]
    [leader]
        type=Elvish Lady
        id=Galadriel
        name=Galadriel
        unrenamable=yes
        can_recruit=yes
        upkeep=loyal
        extra_recruit=Elvish Archer,Elvish Fighter,Elvish Scout,Elvish Shaman,Mage
	    x=65
    	y=36
        [attack]
            name=ensnare
            description=_"ensnare"
            type=impact
            [specials]
                {WEAPON_SPECIAL_SLOW}
            [/specials]
            damage=7
            number=4
            range=ranged
            icon=attacks/entangle.png
       [/attack]
       [attack]
            name=faerie fire
            description= _"faerie fire"
            type=arcane
            icon=attacks/faerie-fire.png
            [specials]
                {WEAPON_SPECIAL_MAGICAL}
            [/specials]
            range=ranged
            damage=7
            number=5
        [/attack]
        [variables]
            std_recruits=Elvish Archer,Elvish Fighter,Elvish Scout,Elvish Shaman,Mage
        [/variables]
    [/leader]
    [leader]
        type=Elvish Avenger
        id=Thranduil
        name=Thranduil
        unrenamable=yes
        can_recruit=yes
        upkeep=loyal
        extra_recruit=Elvish Archer,Elvish Fighter,Elvish Scout,Elvish Shaman,Mage
	    x=95
    	y=10
        [variables]
            std_recruits=Elvish Archer,Elvish Fighter,Elvish Scout,Elvish Shaman,Mage
        [/variables]
    [/leader]
    [village] # Rivendell
        x=59
        y=21
    [/village]
    [village] # Lorien
        x=65
        y=36
    [/village]
    [village] # Castle of Mirkwood Elves
        x=95
        y=10
    [/village]
    [ai]
        aggression=0.1
        caution=0.75
        support_villages=yes
        scout_village_targeting=3
        village_value=3
        villages_per_scout=2
    [/ai]
[/side]
[side]
    side=6
    faction=Custom
    faction_lock=true
    recruit=
    gold=200
    income=0
    team_name="Free Peoples"
    side_name="Rangers"
    current_player="Aragorn"
    color=teal
    no_leader=yes
    [leader]
        type=Lieutenant
        id=Aragorn
        name=Aragorn
        unrenamable=yes
        extra_recruit=Peasant,Bowman,Spearman,Cavalryman,Horseman,Heavy Infantryman
        x=33
        y=22
        [abilities]
            {ABILITY_HEALS}
        [/abilities]
        [variables]
            std_recruits=Peasant,Bowman,Spearman,Cavalryman,Horseman,Heavy Infantryman
        [/variables]
    [/leader]
    [leader]
        type=Dwarvish Steelclad
        id=Gimli
        name=Gimli
        unrenamable=yes
        extra_recruit=Dwarvish Guardsman,Dwarvish Scout,AE_stf_triththa_Crossbowman,AE_stf_triththa_Smith
        x=33
        y=20
        [variables]
            std_recruits=Dwarvish Guardsman,Dwarvish Scout,AE_stf_triththa_Crossbowman,AE_stf_triththa_Smith
        [/variables]
    [/leader]
    [leader]
        type=Swordsman
        id=Halbarad
        name=Halbarad
        unrenamable=yes
        extra_recruit=Peasant,Bowman,Spearman,Cavalryman,Horseman,Heavy Infantryman
        x=32
        y=20
        [variables]
            std_recruits=Peasant,Bowman,Spearman,Cavalryman,Horseman,Heavy Infantryman
        [/variables]
    [/leader]
    [leader]
        type=Elvish Marksman
        id=Legolas
        name=Legolas
        unrenamable=yes
        extra_recruit=Elvish Archer,Elvish Fighter,Elvish Scout
        x=32
        y=21
        [variables]
            std_recruits=Elvish Archer,Elvish Fighter,Elvish Scout
        [/variables]
    [/leader]
    [leader]
        type=Wizard
        id=Gandalf
        name=Mithrandir
        unreanamable=yes
        extra_recruit=Peasant,Mage
        x=33
        y=21
        [variables]
            std_recruits=Peasant,Mage
        [/variables]
    [/leader]
    [ai]
        aggression=0.1
        caution=0.75
        support_villages=yes
    [/ai]
    [variables]
        patrol_enemies=Wolf Rider,Vampire Bat
        patrol_waypoints_x=6,10,7,4,7,13,14,23,21,32,26,23
        patrol_waypoints_y=21,32,39,43,53,51,57,56,47,42,37,29,
    [/variables]
[/side]
[side]
    side=7
    faction=Custom
    faction_lock=true
    recruit=
    gold=200
    income=0
    team_name="Shadow"
    side_name="Moria"
    current_player="Balrog"
    color=red
    no_leader=yes
    [leader]
        type=Balrog
        id=Balrog
        name="Durin's Bane"
        unrenamable=yes
        extra_recruit=Goblin Spearman,Orcish Archer,Orcish Assassin,Orcish Grunt,Orcish Leader,WoR Troll Whelp,Wolf Rider,Young Ogre
        x=56
        y=35
        [variables]
            std_recruits=Goblin Spearman,Orcish Archer,Orcish Assassin,Orcish Grunt,Orcish Leader,WoR Troll Whelp,Wolf Rider,Young Ogre
        [/variables]
    [/leader]
    [leader]
        type=Troll Shaman
        id=Troll King
        extra_recruit=Goblin Spearman,Orcish Archer,Orcish Assassin,Orcish Grunt,Orcish Leader,WoR Troll Whelp,Wolf Rider
        x=64
        y=2
        [variables]
            std_recruits=Goblin Spearman,Orcish Archer,Orcish Assassin,Orcish Grunt,Orcish Leader,WoR Troll Whelp,Wolf Rider
        [/variables]
    [/leader]
    {PETRIFIED Troll "Tom" 50 19}
    {PETRIFIED Troll "Bert" 51 19}
    {PETRIFIED "Troll Hero" "William" 51 20}
    [village] # Moria
        x=56
        y=35
    [/village]
    [village] # Mount Gundabad
        x=64
        y=2
    [/village]
    [ai]
        aggression=0.1
        caution=0.75
        support_villages=yes
        scout_village_targeting=3
        village_value=3
        villages_per_scout=4
    [/ai]
    [variables]
        patrol_enemies=Cavalryman,Gondor Cavalryman,Elvish Scout,Dwarvish Scout
        patrol_waypoints_x=41,32,26,7,10,6,23,36
        patrol_waypoints_y=45,42,37,39,32,21,29,36
    [/variables]
[/side]
[side]
    side=8
    faction=Custom
    faction_lock=true
    recruit=
    gold=200
    income=0
    team_name="Free Peoples"
    side_name="Dwarves"
    current_player="Dain"
    color=brown
    no_leader=yes
    [leader]
        type=Dwarvish Lord
        id=Dain
        name=Dain Ironfoot
        unrenamable=yes
        extra_recruit=AE_ext_dwarves_Dwarvish_Fighter,Dwarvish Guardsman,Dwarvish Scout,AE_ext_dwarves_Dwarvish_Thunderer,Dwarvish Ulfserker,AE_stf_triththa_Crossbowman,AE_stf_triththa_Smith
        x=107
        y=9
        [variables]
            std_recruits=AE_ext_dwarves_Dwarvish_Fighter,Dwarvish Guardsman,Dwarvish Scout,AE_ext_dwarves_Dwarvish_Thunderer,Dwarvish Ulfserker,AE_stf_triththa_Crossbowman,AE_stf_triththa_Smith
        [/variables]
    [/leader]
    [village] # Erebor
        x=107
        y=9
    [/village]
    [ai]
        aggression=0.1
        caution=0.75
        support_villages=yes
    [/ai]
    [variables]
        patrol_enemies=Wolf Rider,Vampire Bat,WoR Little Spider
        patrol_waypoints_x=110,104,113,116,120,110,105,98,101,113,119,
        patrol_waypoints_y=15,22,25,30,42,49,43,44,32,25,17
    [/variables]
[/side]
[side]
    side=9
    hidden=yes
    controller=ai
    allow_player=false
    share_vision=none
    faction=Custom
    faction_lock=true
    recruit=
    gold=0
    income=0
    team_name="Free Peoples"
    side_name="Ents"
    color=green
    no_leader=yes
    {FANGORN_DEFENDER 59 44}
    {FANGORN_DEFENDER 58 45}
    {FANGORN_DEFENDER 56 47}
    {FANGORN_DEFENDER 58 49}
    {FANGORN_DEFENDER 60 51}
    {FANGORN_DEFENDER 63 51}
    {FANGORN_DEFENDER 66 49}
    {FANGORN_DEFENDER 66 46}
    {FANGORN_DEFENDER 63 45}
    {FANGORN_DEFENDER 60 44}
    {FANGORN_DEFENDER 60 46}
    {FANGORN_DEFENDER 59 48}
    {FANGORN_DEFENDER 60 49}
    {FANGORN_DEFENDER 62 47}
    {FANGORN_DEFENDER 62 48}
    {FANGORN_DEFENDER 64 48}
    {FANGORN_DEFENDER 64 46}
    {FANGORN_DEFENDER 64 49}
[/side]

# Setup
[event]
    id=setup
    name=prestart
    [set_variable]
        name=active_ringwraiths
        value=1
    [/set_variable]
    [set_variable]
        name=fires_lit
        value=no
    [/set_variable]

    {MORIA_TUNNEL moria_to_west 49 35}
    {MORIA_TUNNEL moria_to_n_lorien 64 30}
    {MORIA_TUNNEL moria_to_s_lorien 59 41}
    {MORIA_TUNNEL moria_to_dunland 44 44}
    {MORIA_TUNNEL moria_to_fangorn 54 50}
    {MORIA_TUNNEL moria_to_s_rivendell 60 27}
    {MORIA_TUNNEL moria_to_old_ford 69 21}

    [micro_ai]
        ca_id=Ents_guard_Fangorn
        ai_type=zone_guardian
        side=9
        action=add
        [filter]
        [/filter]
        [filter_location]
            area=Fangorn
        [/filter_location]
    [/micro_ai]

    # Send the Fellowship members to northern outposts
    [store_unit]
        variable=northern_leaders
        [filter]
            side=6
            id=Aragorn,Halbarad,Legolas,Gimli,Gandalf
        [/filter]
    [/store_unit]
    [store_locations]
        variable=northern_outposts
        x=5,6,18,22,34
        y=6,14,13,21,20
    [/store_locations]
    [foreach]
        array=northern_leaders
        variable=this_character
        [do]
            [set_variable]
                name=target_outpost
                rand=0..$($northern_outposts.length - 1)
            [/set_variable]
            [micro_ai]
                ai_type=goto
                side=6
                action=add
                [filter]
                    id=$this_character.id
                [/filter]
                [filter_location]
                    x=$northern_outposts[$target_outpost].x
                    y=$northern_outposts[$target_outpost].y
                [/filter_location]
                release_unit_at_goal=yes
            [/micro_ai]
            [clear_variable]
                name=northern_outposts[$target_outpost]
            [/clear_variable]
        [/do]
    [/foreach]
    [clear_variable]
        name=northern_outposts
    [/clear_variable]
    [clear_variable]
        name=northern_leaders
    [/clear_variable]
    [clear_variable]
        name=target_outpost
    [/clear_variable]

    # Village patrols
    [store_side]
        variable=all_sides
        mode=always_clear
        side=2,3,4,6,7,8
    [/store_side]
    [foreach]
        array=all_sides
        variable=this_side
        [do]
            [micro_ai]
                ai_type=patrol
                side=$this_side.side
                action=add
                [filter]
                    role=patrol
                [/filter]

                attack=$this_side.variables.enemy_patrols
                attack_range=5
                waypoint_x=$this_side.variables.patrol_waypoints_x
                waypoint_y=$this_side.variables.patrol_waypoints_y
            [/micro_ai]
        [/do]
    [/foreach]
    [clear_variable]
        name=all_sides
    [/clear_variable]
[/event]

# Limit the number of active Ringwraiths.
[event]
    id=recruit_ringwraith
    name=recruit
    first_time_only=no
    [filter]
        side=1
        type=Ringwraith,Ringwraith Shadow,Ringwraith King
    [/filter]
    [set_variable]
        name=active_ringwraiths
        add=1
    [/set_variable]
    [if]
        [variable]
            name=active_ringwraiths
            greater_than_equal_to=9
        [/variable]
        [then]
            [disallow_extra_recruit]
                side=1
                id=WitchKing
                extra_recruit=Ringwraith Shadow
            [/disallow_extra_recruit]
        [/then]
    [/if]
[/event]

[event]
    id=ringwraith_dies
    name=die
    first_time_only=no
    [filter]
        side=1
        type=Ringwraith,Ringwraith Shadow,Ringwraith King
    [/filter]
    [set_variable]
        name=active_ringwraiths
        sub=1
    [/set_variable]
    [allow_extra_recruit]
        side=1
        id=WitchKing
        extra_recruit=Ringwraith Shadow
    [/allow_extra_recruit]
[/event]

# Recruiting patrols
[event]
    id=recruit_patrol
    name=recruit
    first_time_only=no
    [filter]
        formula="self.usage = 'scout'"
    [/filter]
    [if]
        [not]
            [have_unit]
                side=$side_number
                role=patrol
                count=3
            [/have_unit]
        [/not]
        [then]
            [role]
                id=$unit.id
                role=patrol
            [/role]
        [/then]
    [/if]
[/event]

# Saruman's Doomsay
[event]
    id=doomsay_kills
    name=last_breath
    first_time_only=no
    [filter_second_attack]
        name=doomsay
    [/filter_second_attack]
    [animate_unit]
        flag=levelin
        [filter]
            id=$unit.id
        [/filter]
    [/animate_unit]
    [modify_unit]
        [filter]
            id=$unit.id
        [/filter]
        side=4 # Isengard
        hitpoints=$($unit.max_hitpoints / 5)
        moves=$unit.maxmoves
    [/modify_unit]
[/event]

{LOCAL_RECRUITS Dunland_recruit 31 50 "Footpad,Thug,Thief,Poacher" "1,2,3,4,5,6,7,8"}
{LOCAL_RECRUITS Fangorn_recruit 61 48 "AE_chs_sylvians_Wose" "5,6"}
{LOCAL_RECRUITS Dunharrow_recruit 68 68 "Skeleton,Skeleton Archer,Ghoul,Walking Corpse" "6"}
{LOCAL_RECRUITS Eagles_recruit_north 63 8  "Eagle" "5,6"}
{LOCAL_RECRUITS Eagles_recruit_south 52 42 "Eagle" "5,6"}
{LOCAL_RECRUITS Eagles_recruit_west  5 6   "Eagle" "5,6"}
{LOCAL_RECRUITS Mirkwood_recruits_1 79 12 "WoR Little Spider,AE_efm_pygmies_Spider_Rider" "1,4,7"}
{LOCAL_RECRUITS Mirkwood_recruits_2 94 21 "WoR Little Spider,AE_efm_pygmies_Spider_Rider" "1,4,7"}
{LOCAL_RECRUITS Mirkwood_recruits_3 99 25 "WoR Little Spider,AE_efm_pygmies_Spider_Rider" "1,4,7"}
{LOCAL_RECRUITS Mirkwood_recruits_4 94 38 "WoR Little Spider,AE_efm_pygmies_Spider_Rider" "1,4,7"}

# WOODCUTTING
[event]
    id=woodcutting
    name=moveto
    first_time_only=no
    [filter]
        type="RfC Orcish Woodcutter"
        [filter_location]
            terrain="*^F*"
        [/filter_location]
    [/filter]
    [if]
        [have_location]
        x,y=$x1,$y1
        terrain=G*^F*
        [/have_location]
        [then]
            [terrain]
                terrain=Gll
                x,y=$x1,$y1
            [/terrain]
        [/then]
        [else]
            [terrain]
                terrain=Hhd
                x,y=$x1,$y1
            [/terrain]
        [/else]
    [/if]
    [sound]
        name=wose-hit.ogg
    [/sound]
    [floating_text]
        x,y=$x1,$y1
        text="<span color='gold'>"+_"5"+"</span>"
    [/floating_text]
    [modify_unit]
        [filter]
            x,y=$x1,$y1
        [/filter]
        moves=0
        attacks_left=0
    [/modify_unit]
    [gold]
        side="$side_number"
        amount=5
    [/gold]
    [redraw]
    [/redraw]
[/event]

# Gondor lights the fires.
[event]
    id=gondor_calls_for_help
    name=moveto
    first_time_only=no
    [filter]
        side=2 # Gondor
        x,y=90,71
    [/filter]
    [if]
        [have_unit]
            id=Denethor
        [/have_unit]
        [variable]
            name=fires_lit
            equals=no
        [/variable]
        [then]
            [message]
                speaker=unit
                message="My Lord Denethor, shall we call for Rohan's help in this dark hour?"
                side_for=2,3
            [/message]
            [message]
                speaker=Denethor
                side_for=2,3
                variable=fires_lit
                [option]
                    message="Aye, light the fires!"
                    value=yes
                    [command]
                        [terrain]
                            x=63,66,71,77,83,90
                            y=63,66,68,69,71,71
                            layer=overlay
                            terrain="^Ebn" # lit brazier
                        [/terrain]
                        [tunnel]
                            id=rohan_to_gondor
                            bidirectional=no
                            allow_vision=no
                            pass_allied_units=yes
                            [filter]
                                side=1,2,3,4,5,6,7,8,9
                            [/filter]
                            [source] # Helm's Deep
                                x=58
                                y=61
                            [/source]
                            [target] # road south of Minas Tirith
                                x=92
                                y=74
                            [/target]
                        [/tunnel]
                    [/command]
                [/option]
                [option]
                    message="Nay, we can defend ourselves."
                    value=no
                [/option]
            [/message]
        [/then]
    [/if]
[/event]

# At the start of each Gondor's turn remove the tunnel from Rohan.
# This way any side can use it for a single turn, including the enemies!
[event]
    id=close_tunnel_to_gondor
    name=side turn
    first_time_only=no
    [if]
        [variable]
            name=side_number
            equals=2 # Gondor
        [/variable]
        [then]
            [tunnel]
                id=rohan_to_gondor
                remove=yes
            [/tunnel]
        [/then]
    [/if]
[/event]

# When an Ent is killed, all Ents attack Isengard.
[event]
    id=ent_killed
    name=die
    [filter]
        side=9
    [/filter]
    [micro_ai]
        ca_ai=Ents_conquer_Isengard
        ai_type=goto
        side=9
        action=add
        ca_score=500000 # More than guarding Fangorn
        [filter]
        [/filter]
        [filter_location]
            x=49
            y=53
        [/filter_location]
        ignore_enemy_at_goal=yes
        ignore_units=yes
    [/micro_ai]
[/event]

# Sink Isengard if entered by Ents.
[event]
    id=sink_Isengard
    name=enter_hex
    [filter]
        race=wose
        x=49,50
        y=54,53
    [/filter]

    [terrain]
        x=49
        y=53
        terrain="Khw^Vov"
    [/terrain]
    [terrain]
        x=48,49,49,50
        y=52-53,52,54,52-53
        terrain="Chw"
    [/terrain]
    [message]
        speaker=unit
        message="Isengard is no more."
        sound="water-blast.wav"
    [/message]
    [harm_unit]
        [filter]
            [filter_location] # Orthank is not affected.
                x=48,49,49,50
                y=52-53,52,54,52-53
            [/filter_location]
            [not]
                race=wose
            [/not]
        [/filter]
        amount=$($this_unit.max_hitpoints / 2)
    [/harm_unit]
[/event]

# Dwarves reclaim Moria
[event]
    id=dwarf_conquers_moria
    name=moveto
    [filter]
        race=dwarf
        side=6,8
        x=56
        y=35
    [/filter]
    [message]
        speaker=unit
        message="I hereby reclaim Durin's legacy! Khazad-dûm is restored."
    [/message]
    [label]
        x=56
        y=35
        text="Khazad-dûm"
        color=255,255,255
        visible_in_fog=yes
    [/label]
    [terrain]
        x=56
        y=35
        terrain="Kud^Vov"
    [/terrain]
    [terrain]
        x=55,56,56,57
        y=35-36,34,36,35-36
        terrain="Cud"
    [/terrain]
    [lua]
        code=<<
        local unit = wesnoth.units.get(56, 35)
        unit.canrecruit = true
        unit.experience = unit.experience + unit.max_experience
        wesnoth.units.advance(unit)
        >>
    [/lua]
[/event]

# Dwarves reclaim Mt Gundabad
[event]
    id=dwarf_conquers_gundabad
    name=moveto
    [filter]
        race=dwarf
        side=6,8
        x=64
        y=2
    [/filter]
    [message]
        speaker=unit
        message="I hereby reclaim Durin's legacy! Mount Gundabad is restored."
    [/message]
    [terrain]
        x=64
        y=2
        terrain="Kud^Vov"
    [/terrain]
    [terrain]
        x=63,64,64,65
        y=2-3,1,3,2-3
        terrain="Cud"
    [/terrain]
    [lua]
        code=<<
        local unit = wesnoth.units.get(64, 2)
        unit.canrecruit = true
        unit.experience = unit.experience + unit.max_experience
        wesnoth.units.advance(unit)
        >>
    [/lua]
[/event]

# Fangorn's demise
[event]
    id=Fangorn is dead
    name=die
    [filter]
        side=9
    [/filter]
    [if]
        [have_unit] # Ents are no more, Fangorn is destroyed.
            side=9
            count=0
        [/have_unit]
        [then]
            [message]
                speaker=Saruman
                message="Fangorn is no more."
            [/message]
            [remove_event]
                id=Fangorn_recruit
            [/remove_event]
            [terrain_mask]
                x=55
                y=44
                mask="border_size=1
usage=map

_f, _f, _f, _f, Rb^Fdw, Rb^Fdw, Rb, _f, _f, _f, _f, _f, _f, _f, _f
_f, _f, _f, Rb^Fdw, Rb^Fdw, Rb^Fdw, Rb, Rb, Rb, Rb^Fdw, Rb^Fdw, _f, _f, _f, _f
_f, _f, Rb^Fdw, Rb^Fdw, Rb^Fdw, Rb^Fdw, Rb, Rb, Rb, Rb^Fdw, Rb^Fdw, Rb^Fdw, Rb^Fdw, _f, _f
_f, Rb^Fdw, Rb^Fdw, Rb^Fdw, Rb, Rb, Rb, Rb, Rb, Rb, Rb, Rb^Fdw, Rb^Fdw, Rb^Fdw, _f
_f, Rb^Fdw, Rb^Fdw, Rb^Fdw, Rb, Rb, Ce, Ce, Ce, Rb, Rb, Rb^Fdw, Rb^Fdw, Rb^Fdw, Rb^Fdw
_f, Rb^Fdw, Rb^Fdw, Rb^Fdw, Rb, Rb, Ce, Ke, Ce, Rb, Rb, Rb^Fdw, Rb^Fdw, Rb^Fdw, _f
_f, Rb^Fdw, Rb^Fdw, Rb^Fdw, Rb, Rb, Rb, Ce, Rb, Rb, Rb, Rb^Fdw, Rb^Fdw, Rb^Fdw, _f
_f, _f, _f, Rb, Rb, Rb, Rb, Rb, Rb, Rb, Rb^Fdw, Rb^Fdw, Rb^Fdw, Rb^Fdw, _f
_f, _f, _f, Rb, Rb, Rb, Rb^Fdw, Rb, Rb^Fdw, Rb^Fdw, Rb^Fdw, Rb^Fdw, _f, _f, _f
_f, _f, _f, _f, _f, Rb^Fdw, Rb^Fdw, Rb^Fdw, Rb^Fdw, Rb^Fdw, _f, _f, _f, _f, _f
_f, _f, _f, _f, _f, _f, Rb, _f, Rb, _f, _f, _f, _f, _f, _f"

                [rule]
                    old="Gg^Fet"
                    new="Rb^Fdw"
                    terrain="Rb^Fetd"
                [/rule]
            [/terrain_mask]
            {LOCAL_TIME_EVENT Dunland_local_time 49 53 {OWNED_BY "1,4,7" 49 53} Dunland}
            {SET_PERMANENT_SHADOW_IF {OCCUPIED_BY "1,4,7" 49 53} Dunland}
        [/then]
    [/if]
[/event]

[event]
    id=Elrond_dies
    name=die
    [filter]
        id=Elrond
    [/filter]
    {LOCAL_TIME_EVENT Rivendell_local_time 59 21 {OWNED_BY "1,4,7" 59 21} Rivendell}
    {SET_PERMANENT_SHADOW_IF {OCCUPIED_BY "1,4,7" 59 21} Rivendell}
[/event]

[event]
    id=Galadriel_dies
    name=die
    [filter]
        id=Galadriel
    [/filter]
    {LOCAL_TIME_EVENT Lorien_local_time 65 36 {OWNED_BY "1,4,7" 65 36} Lorien}
    {LOCAL_TIME_EVENT Moria_local_time 56 35 {OWNED_BY "1,4,7" 56 35} Moria}
    {SET_PERMANENT_SHADOW_IF {OCCUPIED_BY "1,4,7" 65 36} Lorien}
    {SET_PERMANENT_SHADOW_IF {OCCUPIED_BY "1,4,7" 56 35} Moria}
[/event]

[event]
    id=Thranduil_dies
    name=die
    [filter]
        id=Thranduil
    [/filter]
    {LOCAL_TIME_EVENT Woodelf_realm_local_time 83 38 {OWNED_BY "1,4,7" 83 38} "Woodelf Realm"} # Dol Guldur
[/event]

[event]
    id=baggins_shire
    name=moveto
    [filter]
        side=1
        type="Ringwraith Shadow, Ringwraith, Ringwraith King"
        x=6
        y=21
    [/filter]
    [message]
        speaker=unit
        message="Baggins… Shire…"
    [/message]
[/event]

# Victory conditions
[objectives]
    team_name="Shadow"
    summary="Find and kill owners of the Three Elven Rings: Mithrandir, Elrond and Galadriel. Protect your stronholds."
    [objective]
        condition=win
        description="Elrond is dead"
    [/objective]
    [objective]
        condition=win
        description="Galadriel is dead"
    [/objective]
    [objective]
        condition=win
        description="Mithrandir is dead"
    [/objective]

    [objective]
        condition=lose
        description="Barad-dûr is contorlled by enemy."
    [/objective]
    [objective]
        condition=lose
        description="Dol Guldur is contorlled by enemy."
    [/objective]
    [objective]
        condition=lose
        description="Isengard is contorlled by enemy."
    [/objective]
    [objective]
        condition=lose
        description="Moria/Khazad-dûm is contorlled by enemy."
    [/objective]
    [objective]
        condition=lose
        description="Mount Gundabad is contorlled by enemy."
    [/objective]

    [note]
        description="All of the mentioned enemy leaders must be dead."
        red=0
        green=255
        blue=0
    [/note]
    [note]
        description="Enemy only needs to control 3 out of these 5 strongholds."
        red=255
        green=0
        blue=0
    [/note]
[/objectives]

[event]
    id=elven_ring_owners_dead
    name=die
    first_time_only=no
    [filter]
        id=Gandalf,Elrond,Galadriel
    [/filter]
    [if]
        [have_unit]
            id=Gandalf,Galadriel,Elrond
            count=0
        [/have_unit]
        [then]
            [endlevel]
                [result]
                    side=1,4,7
                    result=victory
                [/result]
                [result]
                    side=2,3,5,6,8
                    result=defeat
                [/result]
            [/endlevel]
        [/then]
    [/if]
[/event]

[objectives]
    team_name="Free Peoples"
    summary="Conquer 3 out of 5 Shadow strongholds. Protect Elrond, Galadriel and Mithrandir."

    [objective]
        condition=win
        description="Barad-dûr is contorlled by an allied party."
    [/objective]
    [objective]
        condition=win
        description="Dol Guldur is contorlled by an allied party."
    [/objective]
    [objective]
        condition=win
        description="Isengard is contorlled by an allied party."
    [/objective]
    [objective]
        condition=win
        description="Moria/Khazad-dûm is contorlled by an allied party."
    [/objective]
    [objective]
        condition=win
        description="Mount Gundabad is contorlled by an allied party."
    [/objective]

    [objective]
        condition=lose
        description="Elrond is dead"
    [/objective]
    [objective]
        condition=lose
        description="Galadriel is dead"
    [/objective]
    [objective]
        condition=lose
        description="Mithrandir is dead"
    [/objective]

    [note]
        description="You only need to control 3 out of these 5 strongholds."
        red=0
        green=255
        blue=0
    [/note]
    [note]
        description="All of the mentioned leaders must be dead."
        red=255
        green=0
        blue=0
    [/note]
[/objectives]

[event]
    id=shadow_fortresses_taken
    name=moveto
    first_time_only=no
    [filter] # Barad-dur, Dol Guldur, Isdengard, Moria, Gundabad
        side=2,3,5,6,8
        x=118,83,49,56,64
        y=65,38,53,35,2
    [/filter]
    [if]
        [have_location]
            x=118,83,49,56,64
            y=65,38,53,35,2
            count=3
            [filter_owner]
                side=2,3,5,6,8
            [/filter_owner]
        [/have_location]
        [then]
            [endlevel]
                [result]
                    side=1,4,7
                    result=defeat
                [/result]
                [result]
                    side=2,3,5,6,8
                    result=victory
                [/result]
            [/endlevel]
        [/then]
    [/if]
[/event]
[/multiplayer]
