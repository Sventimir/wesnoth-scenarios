[multiplayer]
description=""
id="mnd_test"
map_file="test.map"
name="2p. Test"
victory_when_enemies_defeated=yes
{UNDERGROUND}

[side]
    side=1
    faction=Custom
    faction_lock=true
    recruit=AE_rhy_dw_Miner
    gold=200
    income=0
    no_leader=yes
    [leader]
        type=Dwarvish Steelclad
        id=Leader1
        x,y=3,2
    [/leader]
[/side]
[side]
    side=2
    faction=Custom
    faction_lock=true
    recruit=AE_rhy_dw_Miner
    gold=200
    income=0
    no_leader=yes
    [leader]
        type=Dwarvish Steelclad
        id=Leader1
        x,y=28,28
    [/leader]
[/side]

[event]
    name=prestart
    [set_menu_item]
        id=mnd_menu_dig
        description="Dig tunnel"
        [filter_location]
            terrain=Xu
            [filter_adjacent_location]
                [filter]
                    type=AE_rhy_dw_Miner
                    side=$side_number
                    formula="self.moves > 0 and self.attacks_left > 0"
                [/filter]
            [/filter_adjacent_location]
        [/filter_location]
        [command]
            [store_unit]
                variable=digging_miners
                mode=always_clear
                [filter]
                    side=$side_number
                    [filter_location]
                        [filter_adjacent_location]
                            x,y=$x1,$y1
                        [/filter_adjacent_location]
                    [/filter_location]
                [/filter]
            [/store_unit]
            [foreach]
                array=digging_miners
                variable=this_miner
                [do]
                    [set_variables]
                        name=digging_options
                        mode=append
                        [value]
                            message=$this_miner.name
                            [command]
                                [set_variable]
                                    name=digging_miners[$i].moves
                                    sub=1
                                [/set_variable]
                                [set_variable]
                                    name=digging_miners[$i].attacks_left
                                    value=0
                                [/set_variable]
                                [terrain]
                                    terrain=Uu
                                    x,y=$x1,$y1
                                [/terrain]
                            [/command]
                        [/value]
                    [/set_variables]
                [/do]
            [/foreach]
            [message]
                message="Which miner should dig?"
                [insert_tag]
                    name=option
                    variable=digging_options
                [/insert_tag]
                [option]
                    message="No one. I changed my mind!"
                [/option]
            [/message]
            [foreach]
                array=digging_miners
                variable=this_miner
                [do]
                    [unstore_unit]
                        variable=this_miner
                    [/unstore_unit]
                [/do]
            [/foreach]
            [clear_variable]
                name=digging_options
            [/clear_variable]
            [clear_variable]
                name=digging_miners
            [/clear_variable]
        [/command]
    [/set_menu_item]
[/event]
[/multiplayer]
